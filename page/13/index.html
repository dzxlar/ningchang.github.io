<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="dzxblog">
<meta property="og:url" content="http://yoursite.com/page/13/index.html">
<meta property="og:site_name" content="dzxblog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="dzxblog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/13/"/>





  <title>dzxblog</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  















  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">dzxblog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/05/SpringSecurity学习笔记（二）——高级配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="dzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://wx2.sinaimg.cn/mw690/63b4ac8dgy1ffzs5lll1oj20zk0qoq4z.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dzxblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/05/SpringSecurity学习笔记（二）——高级配置/" itemprop="url">SpringSecurity学习笔记（二）——高级配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-05T10:16:18+08:00">
                2017-06-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/权限安全/" itemprop="url" rel="index">
                    <span itemprop="name">权限安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="SpringSecurity学习笔记（二）——-命名空间"><a href="#SpringSecurity学习笔记（二）——-命名空间" class="headerlink" title="SpringSecurity学习笔记（二）—— 命名空间"></a>SpringSecurity学习笔记（二）—— 命名空间</h1><blockquote>
<p>NameSpace：在同一个应用中，为了捕捉最常见使用的框架和提供一个简化的和简洁的语法</p>
</blockquote>
<pre><code>&lt;filter&gt;
    &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
    &lt;filter-class&gt;org.springframework.web.filter.DelegatingFilterProxy&lt;/filter-class&gt;
&lt;/filter&gt;

&lt;filter-mapping&gt;
    &lt;filter-name&gt;springSecurityFilterChain&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
</code></pre><hr>
<h3 id="简单的配置"><a href="#简单的配置" class="headerlink" title="简单的配置"></a>简单的配置</h3><pre><code>&lt;http&gt;
  &lt;intercept-url pattern=&quot;/**&quot; access=&quot;hasRole(&apos;USER&apos;)&quot; /&gt;
  &lt;form-login /&gt;
  &lt;logout /&gt;
&lt;/http&gt;
</code></pre><hr>
<h3 id="Session-管理"><a href="#Session-管理" class="headerlink" title="Session 管理"></a>Session 管理</h3><h4 id="session失效时跳转页面"><a href="#session失效时跳转页面" class="headerlink" title="session失效时跳转页面"></a>session失效时跳转页面</h4><pre><code>&lt;http&gt;
    &lt;session-management invalid-session-url=&quot;/invalidSession.htm&quot; /&gt;
&lt;/http&gt;
</code></pre><h4 id="删除cookie"><a href="#删除cookie" class="headerlink" title="删除cookie"></a>删除cookie</h4><pre><code>&lt;http&gt;
    &lt;logout delete-cookies=&quot;JSESSIONID&quot; /&gt;
&lt;/http&gt;
</code></pre><h4 id="一致性session"><a href="#一致性session" class="headerlink" title="一致性session"></a>一致性session</h4><p>1.<br>     <listener><br>        <listener-class><br>            org.springframework.security.web.session.HttpSessionEventPublisher<br>        </listener-class><br>    </listener></p>
<p>2.</p>
<pre><code>&lt;http&gt;
  &lt;session-management&gt;
      &lt;concurrency-control max-sessions=&quot;1&quot; /&gt;
  &lt;/session-management&gt;
&lt;/http&gt;
</code></pre><h4 id="会话攻击保护"><a href="#会话攻击保护" class="headerlink" title="会话攻击保护"></a>会话攻击保护</h4><p>恶意攻击者可以通过访问一个网站创建一个会话,然后说服另一个用户登录使用相同的会话</p>
<p>设置</p>
<pre><code>&lt;session-management session-fixation-protection=&quot;true&quot;&gt;&lt;/session-management&gt;
</code></pre><h4 id="OpenID"><a href="#OpenID" class="headerlink" title="OpenID"></a>OpenID</h4><pre><code>&lt;openid-login /&gt;


OpenIDAuthenticationToken token =
(OpenIDAuthenticationToken)SecurityContextHolder.getContext().getAuthentication();
List&lt;OpenIDAttribute&gt; attributes = token.getAttributes();
</code></pre><hr>
<pre><code>&lt;global-method-security secured-annotations=&quot;enabled&quot; /&gt;
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/05/SpringSecurity学习笔记（一）/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="dzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://wx2.sinaimg.cn/mw690/63b4ac8dgy1ffzs5lll1oj20zk0qoq4z.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dzxblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/05/SpringSecurity学习笔记（一）/" itemprop="url">SpringSecurity学习笔记（一）—— Java配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-05T09:58:59+08:00">
                2017-06-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/权限安全/" itemprop="url" rel="index">
                    <span itemprop="name">权限安全</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="SpringSecurity学习笔记（一）——-Java配置"><a href="#SpringSecurity学习笔记（一）——-Java配置" class="headerlink" title="SpringSecurity学习笔记（一）—— Java配置"></a>SpringSecurity学习笔记（一）—— Java配置</h2><h3 id="目录概要"><a href="#目录概要" class="headerlink" title="目录概要"></a>目录概要</h3><ul>
<li>验证应用程序每一个URL</li>
<li>生成登录表单对象</li>
<li>通过用户/密码进行表单验证</li>
<li>用户注销</li>
<li>阻止CSRF攻击</li>
<li>设置安全请求头</li>
<li>集成servletAPI</li>
</ul>
<h3 id="Web安全"><a href="#Web安全" class="headerlink" title="Web安全"></a>Web安全</h3><blockquote>
<p>创建Security过滤器(通过springSecurityFilterChain负责所有安全过滤请求)</p>
</blockquote>
<p>基本例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">@EnableWebSecurity</div><div class="line">public class WebSecurityConfiguration extends WebSecurityConfigurerAdapter &#123;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	protected UserDetailsService userDetailsService() &#123;</div><div class="line">		InMemoryUserDetailsManager inMemoryManager = new InMemoryUserDetailsManager();</div><div class="line">		inMemoryManager.createUser(User.withUsername(&quot;admin&quot;).password(&quot;123456&quot;).roles(&quot;SuperAdmin&quot;).build());</div><div class="line">		return inMemoryManager;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">    @Override</div><div class="line">	protected void configure(HttpSecurity http) throws Exception &#123;</div><div class="line">		http.authorizeRequests()</div><div class="line">            //确保任何请求应用程序需要经过身份验证的用户</div><div class="line">		    .anyRequest().authenticated() </div><div class="line">		        .and()</div><div class="line">            //允许用户进行身份验证和基于表单的登录</div><div class="line">	        .formLogin()</div><div class="line">	        	.and()</div><div class="line">            //允许用户通过HTTP基本认证验证</div><div class="line">	        .httpBasic();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<p><strong>AbstractSecurityWebApplicationInitializer确保springSecurityFilterChain得到注册</strong> </p>
<h3 id="Http安全和表单登录"><a href="#Http安全和表单登录" class="headerlink" title="Http安全和表单登录"></a>Http安全和表单登录</h3><hr>
<p>java配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">   @Override</div><div class="line">protected void configure(HttpSecurity http) throws Exception &#123;</div><div class="line">	http.authorizeRequests()</div><div class="line">           //确保任何请求应用程序需要经过身份验证的用户</div><div class="line">	    .anyRequest().authenticated() </div><div class="line">	        .and()</div><div class="line">           //允许用户进行身份验证和基于表单的登录</div><div class="line">        .formLogin()</div><div class="line">        	.and()</div><div class="line">           //允许用户通过HTTP基本认证验证</div><div class="line">        .httpBasic();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<p>xml配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> &lt;http&gt;</div><div class="line">&lt;intercept-url pattern=&quot;/**&quot; access=&quot;authenticated&quot;/&gt;</div><div class="line">&lt;form-login /&gt;</div><div class="line">&lt;http-basic /&gt;</div><div class="line">&lt;/http&gt;</div></pre></td></tr></table></figure></p>
<h3 id="认证请求"><a href="#认证请求" class="headerlink" title="认证请求"></a>认证请求</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">.authorizeRequests()</div><div class="line">     .antMatchers(&quot;/admin&quot;,&quot;/system&quot;,&quot;/resource&quot;).permitAll()</div><div class="line">     .antMatchers(&quot;/product&quot;).hasRole(&quot;admin&quot;)</div><div class="line">     .antMatchers(&quot;/dba&quot;).access(&quot;hasRole(&apos;admin&apos;) and hasRole(&apos;dba&apos;)&quot;)</div><div class="line">     .anyRequest().authenticated()</div></pre></td></tr></table></figure>
<h3 id="注销"><a href="#注销" class="headerlink" title="注销"></a>注销</h3><ul>
<li>清除http session</li>
<li>清除rememberme状态</li>
<li>清除上下文SecurityContextHolder</li>
<li><p>重定向/login?logout</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">.logout()</div><div class="line">          //如果开启CSRF，请求必须为POST</div><div class="line">       .logoutUrl(&quot;/logout&quot;)</div><div class="line">          //注销成功后，跳转页面</div><div class="line">       .logoutSuccessUrl(&quot;/index&quot;)</div><div class="line">          //清除无效session</div><div class="line">       .invalidateHttpSession(true)</div><div class="line">          //自定义LogoutSuccessHandler.class。如果该类生效。忽略logoutSuccessUrl</div><div class="line"> .logoutSuccessHandler(logoutSuccessHandler)</div><div class="line">          //添加LogoutHandler</div><div class="line">          .addLogoutHandler(logoutHandler)                                         </div><div class="line">          //删除cookie			   </div><div class="line">          .deleteCookies(cookieNamesToClear)</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h4 id="LogoutSuccessHandler-的实现类"><a href="#LogoutSuccessHandler-的实现类" class="headerlink" title="LogoutSuccessHandler 的实现类"></a>LogoutSuccessHandler 的实现类</h4><blockquote>
<p>注销成功后发生的操作</p>
</blockquote>
<ul>
<li>SimpleUrlLogoutSuccessHandler</li>
<li>HttpStatusReturningLogoutSuccessHandler</li>
</ul>
<h4 id="LogoutHandler-的实现类"><a href="#LogoutHandler-的实现类" class="headerlink" title="LogoutHandler 的实现类"></a>LogoutHandler 的实现类</h4><blockquote>
<p>处理必要的清理。例如cookie等</p>
</blockquote>
<ul>
<li>PersistentTokenBasedRememberMeServices</li>
<li>TokenBasedRememberMeServices</li>
<li>CookieClearingLogoutHandler</li>
<li>CsrfLogoutHandler</li>
<li>SecurityContextLogoutHandler</li>
</ul>
<h4 id="更多关于注销的文档"><a href="#更多关于注销的文档" class="headerlink" title="更多关于注销的文档"></a>更多关于注销的文档</h4><p><a href="http://docs.spring.io/spring-security/site/docs/4.2.3.BUILD-SNAPSHOT/reference/htmlsingle/#nsa-logout" target="_blank" rel="external">&lt; logout &gt;</a></p>
<p><a href="http://docs.spring.io/spring-security/site/docs/4.2.3.BUILD-SNAPSHOT/reference/htmlsingle/#remember-me-impls" target="_blank" rel="external">Remember-Me</a></p>
<p>通过钩子方法实现自动登录。RememberMeServices接口方法类似如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">autoLogin(req,res)</div><div class="line">loginSuccess(req,res)</div><div class="line">loginFail(req,res)</div></pre></td></tr></table></figure></p>
<p><a href="http://docs.spring.io/spring-security/site/docs/4.2.3.BUILD-SNAPSHOT/reference/htmlsingle/#servletapi-logout" target="_blank" rel="external">HttpServletRequest.logout()</a></p>
<blockquote>
<p>用于记录当前用户。HttpServletRequest.logout()被调用,需要编写一个响应。</p>
</blockquote>
<p><a href="http://docs.spring.io/spring-security/site/docs/4.2.3.BUILD-SNAPSHOT/reference/htmlsingle/#ns-logout" target="_blank" rel="external">认证提供者</a></p>
<p><a href="http://docs.spring.io/spring-security/site/docs/4.2.3.BUILD-SNAPSHOT/reference/htmlsingle/#test-logout" target="_blank" rel="external">Test Logout</a></p>
<pre><code>mvc
.perform(logout())
</code></pre><p><a href="http://docs.spring.io/spring-security/site/docs/4.2.3.BUILD-SNAPSHOT/reference/htmlsingle/#cas-singlelogout" target="_blank" rel="external">CAS单点注销</a></p>
<h3 id="高级认证"><a href="#高级认证" class="headerlink" title="高级认证"></a>高级认证</h3><h4 id="In-Memory"><a href="#In-Memory" class="headerlink" title="In-Memory"></a>In-Memory</h4>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">@Bean</div><div class="line">   public UserDetailsService userDetailsService() throws Exception &#123;</div><div class="line">  InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();</div><div class="line">  manager.createUser(User.withUsername(&quot;user&quot;).password(&quot;password&quot;).roles(&quot;USER&quot;).build());</div><div class="line">  manager.createUser(User.withUsername(&quot;admin&quot;).password(&quot;password&quot;).roles(&quot;USER&quot;,&quot;ADMIN&quot;).build());</div><div class="line">  return manager;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="JDBC"><a href="#JDBC" class="headerlink" title="JDBC"></a>JDBC</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">   @Autowired</div><div class="line">private DataSource dataSource;</div><div class="line"></div><div class="line">@Autowired</div><div class="line">public void configureGlobal(AuthenticationManagerBuilder 	auth) throws Exception &#123;</div><div class="line"> auth</div><div class="line">	.jdbcAuthentication()</div><div class="line">		.dataSource(dataSource)</div><div class="line">		.withDefaultSchema()</div><div class="line">		.withUser(&quot;user&quot;).password(&quot;password&quot;).roles(&quot;USER&quot;).and()</div><div class="line">		.withUser(&quot;admin&quot;).password(&quot;password&quot;).roles(&quot;USER&quot;, &quot;ADMIN&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="自定义授权认证"><a href="#自定义授权认证" class="headerlink" title="自定义授权认证"></a>自定义授权认证</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">   @Bean</div><div class="line">   public SpringAuthenticationProvider springAuthenticationProvider() &#123;</div><div class="line">	 return new SpringAuthenticationProvider();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="自定义身份认证"><a href="#自定义身份认证" class="headerlink" title="自定义身份认证"></a>自定义身份认证</h4><pre><code>@Bean
public SpringDataUserDetailsService springDataUserDetailsService() {
  return new SpringDataUserDetailsService();
}
</code></pre><h4 id="自定义密码加密"><a href="#自定义密码加密" class="headerlink" title="自定义密码加密"></a>自定义密码加密</h4>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> @Bean</div><div class="line"> public BCryptPasswordEncoder passwordEncoder() &#123;</div><div class="line">return new BCryptPasswordEncoder();</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h3 id="多个HttpSecurity"><a href="#多个HttpSecurity" class="headerlink" title="多个HttpSecurity"></a>多个HttpSecurity</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">   @EnableWebSecurity</div><div class="line">   public class MultiHttpSecurityConfig &#123;</div><div class="line">@Bean</div><div class="line">public UserDetailsService userDetailsService() throws Exception &#123;</div><div class="line">	InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();</div><div class="line">	manager.createUser(User.withUsername(&quot;user&quot;).password(&quot;password&quot;).roles(&quot;USER&quot;).build());</div><div class="line">	manager.createUser(User.withUsername(&quot;admin&quot;).password(&quot;password&quot;).roles(&quot;USER&quot;,&quot;ADMIN&quot;).build());</div><div class="line">	return manager;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Configuration</div><div class="line">@Order(1)                                                       1</div><div class="line">public static class ApiWebSecurityConfigurationAdapter extends WebSecurityConfigurerAdapter &#123;</div><div class="line">	protected void configure(HttpSecurity http) throws Exception &#123;</div><div class="line">		http</div><div class="line">			.antMatcher(&quot;/api/**&quot;)                               </div><div class="line">			.authorizeRequests()</div><div class="line">				.anyRequest().hasRole(&quot;ADMIN&quot;)</div><div class="line">				.and()</div><div class="line">			.httpBasic();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Configuration                                                   </div><div class="line">public static class FormLoginWebSecurityConfigurerAdapter extends WebSecurityConfigurerAdapter &#123;</div><div class="line"></div><div class="line">	@Override</div><div class="line">	protected void configure(HttpSecurity http) throws Exception &#123;</div><div class="line">		http</div><div class="line">			.authorizeRequests()</div><div class="line">				.anyRequest().authenticated()</div><div class="line">				.and()</div><div class="line">			.formLogin();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h3 id="方法安全"><a href="#方法安全" class="headerlink" title="方法安全"></a>方法安全</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">@EnableGlobalMethodSecurity(securedEnabled = true)</div><div class="line">public class MethodSecurityConfig &#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">public interface BankService &#123;</div><div class="line"></div><div class="line"> @Secured(&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot;)</div><div class="line"> public Account readAccount(Long id);</div><div class="line"></div><div class="line"> @Secured(&quot;IS_AUTHENTICATED_ANONYMOUSLY&quot;)</div><div class="line"> public Account[] findAccounts();</div><div class="line"></div><div class="line"> @Secured(&quot;ROLE_TELLER&quot;)</div><div class="line"> public Account post(Account account, double amount);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="后置处理"><a href="#后置处理" class="headerlink" title="后置处理"></a>后置处理</h3>   <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">.withObjectPostProcessor(new ObjectPostProcessor&lt;FilterSecurityInterceptor&gt;() &#123;</div><div class="line">	public &lt;O extends FilterSecurityInterceptor&gt; O postProcess(</div><div class="line">			O fsi) &#123;</div><div class="line">		fsi.setPublishAuthorizationSuccess(true);</div><div class="line">		return fsi;</div><div class="line">	&#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<h3 id="自定义DSLs"><a href="#自定义DSLs" class="headerlink" title="自定义DSLs"></a>自定义DSLs</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">   public class MyCustomDsl extends AbstractHttpConfigurer&lt;CorsConfigurerMyCustomDsl, HttpSecurity&gt; &#123;</div><div class="line">private boolean flag;</div><div class="line"></div><div class="line">@Override</div><div class="line">public void init(H http) throws Exception &#123;</div><div class="line">	// any method that adds another configurer</div><div class="line">	// must be done in the init method</div><div class="line">	http.csrf().disable();</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line">public void configure(H http) throws Exception &#123;</div><div class="line">	ApplicationContext context = http.getSharedObject(ApplicationContext.class);</div><div class="line"></div><div class="line">	// here we lookup from the ApplicationContext. You can also just create a new instance.</div><div class="line">	MyFilter myFilter = context.getBean(MyFilter.class);</div><div class="line">	myFilter.setFlag(flag);</div><div class="line">	http.addFilterBefore(myFilter, UsernamePasswordAuthenticationFilter.class);</div><div class="line">&#125;</div><div class="line"></div><div class="line">public MyCustomDsl flag(boolean value) &#123;</div><div class="line">	this.flag = value;</div><div class="line">	return this;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public static MyCustomDsl customDsl() &#123;</div><div class="line">	return new MyCustomDsl();</div><div class="line">&#125;		</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>META-INF/spring.factories.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer = sample.MyCustomDsl</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/05/MySQL记录概要/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="dzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://wx2.sinaimg.cn/mw690/63b4ac8dgy1ffzs5lll1oj20zk0qoq4z.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dzxblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/05/MySQL记录概要/" itemprop="url">MySQL记录概要</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-05T09:55:13+08:00">
                2017-06-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/数据库/" itemprop="url" rel="index">
                    <span itemprop="name">数据库</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MySQL记录概要"><a href="#MySQL记录概要" class="headerlink" title="MySQL记录概要"></a>MySQL记录概要</h1><h2 id="时间函数"><a href="#时间函数" class="headerlink" title="时间函数"></a>时间函数</h2><ul>
<li>curdate() : yyyy-MM-dd</li>
<li>curtime() : HH:mm:ss</li>
<li>now() : yyyy-MM-dd HH:mm:ss</li>
<li>from_unixtime() : 返回时间戳的日期值</li>
<li>unix_timestamp(date) : 时间戳</li>
<li>date_format(date,fmt) : fmt格式化日期<ul>
<li>fmt: %Y-%m-%d %H:%i:%s</li>
</ul>
</li>
<li>date_add(date,interval expr type)：当前日期加上一定时间间隔<ul>
<li>expr type: HOUR(hh)、MINUTE(mm)、SECOND(ss)、YEAR(YY)、MONTH(MM)、DAY(DD)、YEAR_MONTH(YY-MM)、DAY_HOUR(DD hh)、DAY_MINUTE(DD hh:mm)、DAY_SECOND(DD hh:mm:ss)、HOUR_MINUTE(hh:mm)、HOUR_SECOND(hh:ss)、MINUTE_SECOND(mm:ss)</li>
</ul>
</li>
<li>datediff(startDate,endDate):返回两个日期之间的天数</li>
<li>其余日期<ul>
<li>week、year、hour、minutes、monthname</li>
</ul>
</li>
</ul>
<h2 id="流程函数"><a href="#流程函数" class="headerlink" title="流程函数"></a>流程函数</h2><ul>
<li>IF(value,true,false)</li>
<li>IFNULL(value,replaceValue)</li>
<li>CASE [expr] WHEN [value] THEN [result] ELSE [defalut] END</li>
</ul>
<h2 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h2><ul>
<li>CANCAT(str1,str2,…strn) 连接字符串</li>
<li>INSERT(str,x,y,instr) 字符串str在(x,y)位置替换instr</li>
<li>LOWER(str) 小写</li>
<li>UPPER(str) 大写</li>
<li>LEFT(str,x) 最左边的x个字符</li>
<li>RIGHT(str,x) 最右边的x个字符</li>
<li>LTRIM(str)/RTRIM(str) 去掉左右空格</li>
<li>REPLACE(str,a,b) b替换str中出现的a</li>
<li>SUBSTRING(str,x,y) 返回(x,y)长度的字符串</li>
</ul>
<h2 id="数值函数"><a href="#数值函数" class="headerlink" title="数值函数"></a>数值函数</h2><ul>
<li>ABS(x) 返回x的绝对值</li>
<li>CEIL(x) 返回大于x的最大整数值</li>
<li>FLOOR(x) 返回小于x的最大整数值</li>
<li>MOD(x,y) x/y的模</li>
<li>RAND() 0~1内的随机值</li>
<li>ROUND(x,y) 四舍五入</li>
<li>TRUNCATE(x,y) 截断小数位结果</li>
</ul>
<h2 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数</h2><ul>
<li>DATABASE() 数据库</li>
<li>VERSION() 版本</li>
<li>USER() 当前用户</li>
<li>PASSWORD() 加密方式</li>
<li>MD5() MD5字符串</li>
<li>INET_ATON(IP) 返回IP的数字表示</li>
<li>INET_NTOA(num) 返回数字代表的IP地址</li>
</ul>
<hr>
<h2 id="MYSQL工具"><a href="#MYSQL工具" class="headerlink" title="MYSQL工具"></a>MYSQL工具</h2><ul>
<li>MySQL Administrator 管理工具</li>
<li>MySQLdump 备份工具</li>
<li>Catalogs 控制台提供的管理表、索引、视图和过程的工具</li>
<li>MySQL Query Brower 可视化界面的mysql管理工具</li>
<li>phpMyAdmin 通过web控制操作数据的工具</li>
<li>mysqlbinlog 查看binlog</li>
</ul>
<h2 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h2><ul>
<li>InnoDB Online Backup 保障InnoDB数据一致性</li>
<li>Lock all tables 确保MyISAM数据一致性</li>
<li>Online with binlog pos 实现InnoDB Backup功能，科记录Binlog位置，便于恢复</li>
<li>Normal backup 只有备份每个表时才锁定单表，表间一致性无法保障</li>
<li>Complete backup 数据库全备份</li>
</ul>
<h2 id="MySQL存储引擎"><a href="#MySQL存储引擎" class="headerlink" title="MySQL存储引擎"></a>MySQL存储引擎</h2><p>查看Mysql支持的存储引擎</p>
<pre><code>show ENGINE \G  
</code></pre><p>设置表的存储引擎</p>
<pre><code>create table table_name() ENGINE=InnoDB CHARSET=utf-8
</code></pre><p>修改表的存储引擎</p>
<pre><code>alter table_name ENGINE MyISAM
</code></pre><hr>
<h3 id="如何选择引擎"><a href="#如何选择引擎" class="headerlink" title="如何选择引擎"></a>如何选择引擎</h3><ul>
<li>MyISAM:默认的MySQL引擎，对数据一致性要求、完整性和并发性不是很高的插入/查询操作，很少更新删除操作</li>
<li>InnoDB:支持事务、外键，在并发条件保证数据一致性。对数据准确性较为精确</li>
<li>MEMORY:数据存储在内存中，访问速度快。适用于快速定位记录。但是对表大小有限制，确保数据可以恢复，用于更新不太频繁的小表 </li>
<li>MERGE:一系列等同的MyISAM表以逻辑方式组合，作为对象引用它们。优点是突破对单个MyISAM表大小限制</li>
</ul>
<hr>
<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><p>创建索引语法</p>
<pre><code>create [UNIQUE|FULLTEXT|SPATIAL] INDEX idx_name
  [USING index_type]
  ON table_name(idx_col_name)
</code></pre><h2 id="设置索引原则"><a href="#设置索引原则" class="headerlink" title="设置索引原则"></a>设置索引原则</h2><ol>
<li><strong>搜索的索引列</strong>。最适合索引的列是出现在where子句中的列，或连接子句中指定的列</li>
<li><strong>使用唯一索引</strong>。考虑某列中值分布，索引列基数越大，索引效果越好</li>
<li><strong>使用短索引</strong>。对字符串进行索引，应该指定一个前缀长度。</li>
<li><strong>最左前缀</strong>。在创建一个n列索引，实际上是创建mysql可利用的n个索引，多列索引可起几个索引的作用，可利用索引最左边的列集匹配行</li>
<li><strong>不要过度索引</strong>。每个额外的索引都要占据额外的磁盘空间，降低写操作性能。在修改表内容时，索引必须进行更新，花的时间更长。</li>
<li>对于InnoDB的表，默认会按照一定顺序排好，若定义了主键，按照主键顺序保存，没有主键，但是有唯一索引，按照唯一索引顺序保存。如果既没有主键，有没有唯一索引，那么表会自动生成一个内部列，按照这个列的顺序保存。<strong>主键尽可能选择较短的数据类型，有效的减少索引的磁盘占用，提高索引的缓存效果</strong></li>
</ol>
<h3 id="BTree索引和Hash索引"><a href="#BTree索引和Hash索引" class="headerlink" title="BTree索引和Hash索引"></a>BTree索引和Hash索引</h3><p>MEMORY存储引擎时可以使用</p>
<p>HASH重要特征</p>
<ol>
<li>只用于=或&lt;=&gt;操作符之间的比较</li>
<li>优化器不能使用hash索引加速orderby</li>
<li>mysql不能确定在两个值之间大约有多少行。如果将MyISAM改为HASH索引的MEMORY表，将会影响查询效率</li>
<li>只能使用整个关键字搜索一行</li>
</ol>
<p>BTree特征</p>
<ol>
<li>对于&lt;、&gt;、!=、&lt;&gt;、between或者like ‘pattern’时。都可以使用</li>
</ol>
<p>适用于Hash和BTree索引</p>
<pre><code>select * from table_name where key_col = 1 or key_col in (1,2,3);
</code></pre><p>只适用于btree索引</p>
<pre><code>select * from table_name where key_col &gt; 1 and key_col &lt; 10;
select * from table_name where key_col like &apos;ab%&apos; or key_col between &apos;a&apos; and &apos;b&apos;;
</code></pre><p>HASH索引实际是全表扫描的</p>
<hr>
<h2 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h2><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><h4 id="启动XA事务"><a href="#启动XA事务" class="headerlink" title="启动XA事务"></a>启动XA事务</h4><pre><code>XA {START|BEGIN} xid [JOIN|RESUME]
</code></pre><p>XA START xid 用于启动一个带给定xid值的XA事务。每个XA事务必须有一个唯一的xid值</p>
<p>xid是一个XA事务标识符，用来标识一个分布式事务。xid值由客户端提供，MySQL服务器生成</p>
<p>xid包含三个部分</p>
<pre><code>xid: gtrid [, bqual [, formatID ]]
</code></pre><ul>
<li>gtrid:分布式事务标识符，相同的分布式事务应该使用相同的gtrid，可以明确xa事务属于哪个分布式</li>
<li>bqual：分支限定符，默认值为空串。对于一个分布式事务中的每个分支事务必须是唯一的</li>
<li>formatID：数字。用于标识由gtrid和bqual值使用的格式，默认为1</li>
</ul>
<h4 id="进入PREPARE状态（两阶段提交的第一阶段）"><a href="#进入PREPARE状态（两阶段提交的第一阶段）" class="headerlink" title="进入PREPARE状态（两阶段提交的第一阶段）"></a>进入PREPARE状态（两阶段提交的第一阶段）</h4><pre><code>XA END xid [SUSPEND [FOR MIGRATE]]

XA PREPARE xid
</code></pre><h4 id="提交-回滚具体的分支事务-两阶段提交的第二阶段）"><a href="#提交-回滚具体的分支事务-两阶段提交的第二阶段）" class="headerlink" title="提交/回滚具体的分支事务 (两阶段提交的第二阶段）"></a>提交/回滚具体的分支事务 (两阶段提交的第二阶段）</h4><pre><code>XA COMIT xid [ONE PHASE]

XA ROLLBACK xid
</code></pre><h4 id="返回当前数据库处于PREPARE状态的分支事务的详细信息"><a href="#返回当前数据库处于PREPARE状态的分支事务的详细信息" class="headerlink" title="返回当前数据库处于PREPARE状态的分支事务的详细信息"></a>返回当前数据库处于PREPARE状态的分支事务的详细信息</h4><pre><code>XA RECOVER
</code></pre><hr>
<p><strong>分布式关键在于如何确保分布式事务的完整性，以及在某个分支出现问题时的故障解决。</strong></p>
<p>XA的相关命令就是提供给应用如何在多个独立的数据库之间进行分布式事务的管理，包括启动一个分支事务、使事务进入准备阶段以及事务的实际提交回滚操作等</p>
<p>举例：在DB1中插入一条记录，同时在DB2更新一条记录，两个操作作为同一事务提交或回滚</p>
<ol>
<li><p>在数据库DB1中启动一个分布式事务和分支事务,xid的gtrid为”test”，bqual为”db1”</p>
<pre><code>mysql&gt; xa start &apos;test&apos;,&apos;db1&apos;;
mysql&gt; insert into t_products values(5,2,&apos;测试商品&apos;,50,&apos;分布式测试&apos;);
mysql&gt; xa end &apos;test&apos;,&apos;db1&apos;;
mysql&gt; xa prepare &apos;test&apos;,&apos;db1&apos;;

mysql&gt; xa recover;
*************************** 1. row ***************************
formatID: 1
gtrid_length: 4
bqual_length: 3
data: testdb1
</code></pre></li>
<li><p>在数据库DB2中启动一个分布式事务和分支事务,xid的gtrid为”test”，bqual为”db2”</p>
<pre><code>mysql&gt; xa start &apos;test&apos;,&apos;db2&apos;;
mysql&gt; insert into producttype values(MD5(&apos;77&apos;),now(),now(),&apos;分布式测试&apos;);
mysql&gt; xa end &apos;test&apos;,&apos;db2&apos;;
mysql&gt; xa prepare &apos;test&apos;,&apos;db2&apos;;

mysql&gt; xa recover;
*************************** 1. row ***************************
formatID: 1
gtrid_length: 4
bqual_length: 3
data: testdb2
</code></pre></li>
<li><p>提交分支事务</p>
<pre><code>mysql&gt; xa commit &apos;test&apos;,&apos;db1&apos;;
mysql&gt; xa commit &apos;test&apos;,&apos;db2&apos;;
</code></pre></li>
</ol>
<p><strong>注意：两个事务都达到准备提交阶段后，一旦开始进行提交操作，需要确保全部分支提交成功</strong></p>
<h3 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h3><p>1.如果分支事务达到prepare状态，数据库异常重新启动，服务器重新启动后，可以继续对分支事务进行提交或者回滚操作，但是提交的事务没有写binlog，存在一定隐患。可能导致binlog恢复丢失部分数据。</p>
<p>2.如果存在复制的数据库，则有可能导致主从数据不一致。因为复制和灾难恢复都依赖于binlog</p>
<hr>
<h2 id="SQL安全"><a href="#SQL安全" class="headerlink" title="SQL安全"></a>SQL安全</h2><h3 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h3><blockquote>
<p>SQL注入攻击者可以利用它读取，修改或者删除数据库内的数据。一般的防火墙无法进行Sql注入拦截</p>
</blockquote>
<p>“/*”或者”#”可以将后面的语句注释掉</p>
<h3 id="应对措施"><a href="#应对措施" class="headerlink" title="应对措施"></a>应对措施</h3><h4 id="PrepareStatement-Bind-variable"><a href="#PrepareStatement-Bind-variable" class="headerlink" title="PrepareStatement + Bind-variable"></a>PrepareStatement + Bind-variable</h4><p>对于JSP、Java开发的应用来防止SQL注入</p>
<pre><code>String sql = &quot;select userName from userName = ? and userPassword = ?&quot;;
PrepareStatement pstmt = conn.prepareStatement(sql);
pstmt.setString(1,name);
pstmt.setString(2,pwd);
ResultSet rs = pstmt.executeQuery();
</code></pre><h3 id="SQL-Mode"><a href="#SQL-Mode" class="headerlink" title="SQL Mode"></a>SQL Mode</h3><blockquote>
<p>SQL Mode定义MySql应该支持的SQL语法、数据校验等</p>
</blockquote>
<p>SQL Mode 常用来解决</p>
<ul>
<li>通过设置SQL Mode，可以完成不同严格程度的数据校验，保障数据准确性</li>
<li>通过设置SQL Mode为ANSI模式，保证大多数SQL符合标准SQL语法(确保进行不同数据库迁移时，不需要对业务SQL进行较大的修改)</li>
<li><p>不同数据库迁移之前，通过SQL Mode可以使MySQL上的数据更方便迁移到目标数据库中</p>
<pre><code>mysql&gt; select @@sql_mode;

+----------------------------------------------------------------+
| @@sql_mode                                                     |
+----------------------------------------------------------------+
  | STRICT_TRANS_TABLES,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |
+----------------------------------------------------------------+
</code></pre></li>
<li><p>set [session/global] sql_mode = ‘STRICT_TRANS_TABLES’ ： 设置严格模式。当记录插入失败，直接失败。返回ERROR</p>
</li>
</ul>
<h4 id="RAND提取随机行"><a href="#RAND提取随机行" class="headerlink" title="RAND提取随机行"></a>RAND提取随机行</h4><pre><code>-- 按照数据随机排序，并选择前10
select * from table_name order by rand() limit 10;
</code></pre><p>按照随机顺序检索数据行</p>
<h4 id="GROUP-BY-的-WITH-ROLLUP-做统计"><a href="#GROUP-BY-的-WITH-ROLLUP-做统计" class="headerlink" title="GROUP BY 的 WITH ROLLUP 做统计"></a>GROUP BY 的 WITH ROLLUP 做统计</h4><p>可以检索出更多的分组聚合信息。with rollup反映的是一种OLAP思想</p>
<p>注意：<br>1.当使用ROLLUP时，不能同时使用ORDER BY<br>2.LIMIT用在WITH ROLLUP的后面</p>
<h3 id="SQL-优化"><a href="#SQL-优化" class="headerlink" title="SQL 优化"></a>SQL 优化</h3><h4 id="通过show-status了解各种SQL执行频率"><a href="#通过show-status了解各种SQL执行频率" class="headerlink" title="通过show status了解各种SQL执行频率"></a>通过show status了解各种SQL执行频率</h4><pre><code>show status like &apos;Com_%&apos;;
</code></pre><ul>
<li>Com_select: 查询操作次数</li>
<li>Com_insert: 新增操作次数</li>
<li>Com_delete: 删除操作次数</li>
<li>Com_update: 修改操作次数</li>
</ul>
<p>查看事务提交回滚情况</p>
<ul>
<li>Com_commit</li>
<li><p>Com_rollback</p>
<pre><code>show status like &apos;Innodb_%&apos;;
</code></pre></li>
<li><p>Innodb_rows_read: select返回的行数</p>
</li>
<li>Innodb_rows_inserted: 执行insert插入的行数</li>
<li>Innodb_rows_updated: 执行update更新行数</li>
<li>Innodb_rows_deleted: 执行delete删除行数</li>
</ul>
<p>对于回滚操作非常频繁的数据库，可能以为编写存在问题</p>
<ul>
<li>Connections 试图连接MySql服务器的次数</li>
<li>Uptime：服务器工作时间</li>
<li>Slow_queries: 慢查询次数</li>
</ul>
<h4 id="定位执行效率较低的SQL语句"><a href="#定位执行效率较低的SQL语句" class="headerlink" title="定位执行效率较低的SQL语句"></a>定位执行效率较低的SQL语句</h4><ul>
<li>通过慢查询日志定位<ul>
<li>用log-slow-queries[=file_name]启动时，mysqlId写一个包含所有执行时间超过long_query_time秒的SQL语句的日志文件</li>
<li>慢查询日志在查询结束后记录，只能反应效率不能定位问题</li>
</ul>
</li>
<li>使用show processlist查看MySQL进行中的线程（包括线程状态、是否锁表等）、实时查看SQL执行情况</li>
</ul>
<h4 id="通过EXPLAIN-DESC分析低效SQL执行计划"><a href="#通过EXPLAIN-DESC分析低效SQL执行计划" class="headerlink" title="通过EXPLAIN/DESC分析低效SQL执行计划"></a>通过EXPLAIN/DESC分析低效SQL执行计划</h4><ul>
<li>select_type<ul>
<li>SIMPLE:单表</li>
<li>PRIMARY：外层查询（主查询）</li>
<li>UNION：union中第二个或者后面的查询语句</li>
<li>SUBQUERY：子查询中的第一个select</li>
</ul>
</li>
<li>table: 输出结果集的表</li>
<li>type：表的连接类型<ul>
<li>性能由好到差:system&gt;const&gt;eq_ref&gt;ref_or_null&gt;index_subquery&gt;unique_subquery&gt;index_subquery&gt;range&gt;index&gt;all</li>
<li>表中仅有一行(常量表)&gt;单表中最多一个匹配行pk和uq_idx&gt;多表连接中使用pk和uq_idx&gt;使用普通索引&gt;与ref类似包含对NULL的查询&gt;索引合并优化&gt;一个查询主键字段的子查询&gt;非唯一索引字段的子查询&gt;单表中范围查询&gt;对于前面的每一行通过查询索引得到的数据&gt;全表查询</li>
</ul>
</li>
<li>possible_key:可能使用的索引</li>
<li>key：实际使用的索引</li>
<li>key_len:索引字段的长度</li>
<li>rows：扫描行数量</li>
<li><p>extra：执行情况的说明和描述</p>
<pre><code>id: 1
  select_type: SIMPLE
table: region
   partitions: NULL
type: ALL
possible_keys: NULL
key: NULL
 key_len: NULL
ref: NULL
rows: 3524
 filtered: 100.00
Extra: NULL
</code></pre></li>
</ul>
<hr>
<h2 id="索引存储分类"><a href="#索引存储分类" class="headerlink" title="索引存储分类"></a>索引存储分类</h2><h3 id="MySQL支持的存储类型"><a href="#MySQL支持的存储类型" class="headerlink" title="MySQL支持的存储类型"></a>MySQL支持的存储类型</h3><ol>
<li>Hash(MEMORY和HEAP两者都可以使用)</li>
<li>BTree(MyISAM和InnoDB)</li>
<li>不支持函数索引(根据文本字符长度进行索引)</li>
</ol>
<h3 id="使用索引"><a href="#使用索引" class="headerlink" title="使用索引"></a>使用索引</h3><blockquote>
<p><strong>索引用于快速找出在某个列中有一特定值的行。</strong><br>**使用索引的主要条件是查询条件中需要使用索引关键字，如果是多列索引，需要满足最左前缀原则，才可使用，否则不能使用索引</p>
</blockquote>
<h3 id="索引有效-失效"><a href="#索引有效-失效" class="headerlink" title="索引有效/失效"></a>索引有效/失效</h3><ol>
<li>假设有一个复合索引idx_test(col_1,col_2)。where条件只跟col_1都能匹配到索引，如果where后面只跟col_2则不能匹配</li>
<li>对于like查询，%如果在第一个字符，索引则失效</li>
<li>对于大文本搜索，使用全文索引，而不是使用like ‘%..%’</li>
<li>如果列名是索引，使用col_name is null条件，索引有效</li>
<li>索引比全表扫描满，则不使用索引。</li>
<li>如果使用MEMORY/HEAP表并且where条件不适用=进行索引列，则不会使用</li>
<li>用or分隔开的条件，如果or前的条件中列有索引，而后面没有索引，则涉及的索引失效</li>
<li>列类型为字符串，在where条件中的字符常量值通过引号。否则索引失效</li>
</ol>
<h3 id="查看索引使用情况"><a href="#查看索引使用情况" class="headerlink" title="查看索引使用情况"></a>查看索引使用情况</h3><pre><code>mysql&gt; show status like &apos;Handler_read%&apos;
+-----------------------+-------+
| Variable_name         | Value |
+-----------------------+-------+
| Handler_read_first    | 0     |
| Handler_read_key      | 0     | 
| Handler_read_last     | 0     |
| Handler_read_next     | 0     |
| Handler_read_prev     | 0     |
| Handler_read_rnd      | 0     |
| Handler_read_rnd_next | 0     |
+-----------------------+-------+
</code></pre><ul>
<li>Handler_read_key ： 代表行被索引值读次数。值越高说明索引使用频率越多</li>
<li>Handler_read_rnd_next： 数据文件读取下一行请求数。值越高查询越低下，应该建立索引补救（通常代表索引不正确或没有利用索引）</li>
</ul>
<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><ol>
<li><p>定期分析表和检查表</p>
<pre><code>ANALYZE [LOCAL|NO_WRITE_TO_BINLOG] TABLE table_name [,table_name_2,...]
</code></pre></li>
<li><p>定期优化表</p>
<pre><code>OPTIMizE [LOCAL|NO_WRITE_TO_BINLOG] TABLE table_name [,table_name_2,...]
</code></pre></li>
</ol>
<p><strong>注意：ANALYZE、CHECK、OPTIMIZE执行期间会对表进行锁定</strong></p>
<h2 id="常用SQL优化"><a href="#常用SQL优化" class="headerlink" title="常用SQL优化"></a>常用SQL优化</h2><h3 id="1-大批量导入数据"><a href="#1-大批量导入数据" class="headerlink" title="1.大批量导入数据"></a>1.大批量导入数据</h3><ul>
<li><p>当用load命令导入数据时，适当设置提高导入速度</p>
</li>
<li><p>对于MyISAM引擎表，设置如下</p>
<pre><code>alter table table_name DISABLE KEYS;
loading the data
alter table table_name ENABLE KEYS;
</code></pre></li>
<li><p>DISABLE/ENABLE：打开/关闭MyISAM非唯一索引的更新</p>
<pre><code>load data infile &apos;path&apos; into table table_name;
</code></pre></li>
<li><p>对于InnoDB引擎表，设置如下</p>
<pre><code>set unique_checks = 0 --导入数据前，关闭唯一性校验
set unique_checks = 1 --导入结束后，恢复唯一性校验
</code></pre></li>
<li><p>如果使用自动提交方式</p>
<pre><code>set autocommit = 0 --关闭自动提交
set autocommit = 1 --打开自动提交
</code></pre></li>
</ul>
<h3 id="2-优化insert"><a href="#2-优化insert" class="headerlink" title="2.优化insert"></a>2.优化insert</h3><ul>
<li><p>同一用户插入很多行，尽量使用多个值表的insert语句。缩减客户端与数据库之间的连接/关闭消耗</p>
<pre><code>insert into table_name values(),(),()...
</code></pre></li>
<li><p>不同用户插入很多行，使用insert delayed得到更高的速度</p>
<ul>
<li>delayed让insert语句马上执行，其实是放在内存都列中，并没有写入磁盘。比每条语句插入快。LOW_PRIORITY相反，在所有其他用户对表的读写完后才进行插入</li>
</ul>
</li>
<li>索引文件和数据文件分别放在不同的磁盘</li>
<li>如果进行批量插入，增加bulk_insert_buffer_size提高速度，只对MyISAM使用</li>
<li>当从一个文本文件加载一个表时，使用load data infile。比insert快</li>
</ul>
<h3 id="3-优化GROUP-BY"><a href="#3-优化GROUP-BY" class="headerlink" title="3.优化GROUP BY"></a>3.优化GROUP BY</h3><ul>
<li>order by null ： 禁止排序。避免排序结果消耗</li>
</ul>
<h3 id="4-优化ORDER-BY"><a href="#4-优化ORDER-BY" class="headerlink" title="4.优化ORDER BY"></a>4.优化ORDER BY</h3><ul>
<li>在某些情况，使用一个索引满足order by而不需要额外排序。where和order by使用的是相同索引。</li>
<li>混用DESC、ASC索引不生效</li>
<li>查询行的关键字与ORDER BY中不一致</li>
</ul>
<h3 id="5-优化嵌套查询（子查询）"><a href="#5-优化嵌套查询（子查询）" class="headerlink" title="5.优化嵌套查询（子查询）"></a>5.优化嵌套查询（子查询）</h3><ul>
<li>通过子查询创建一个单列的查询结果，然后把这个结果作为过滤条件在另外一个条件中。使用子查询避免事务或者表锁死。某些情况下子查询被更有效率的JOIN替代</li>
</ul>
<h3 id="6-优化OR条件"><a href="#6-优化OR条件" class="headerlink" title="6.优化OR条件"></a>6.优化OR条件</h3><ul>
<li><p>OR之间的每个条件列都必须用到索引</p>
<pre><code>show index from table_name --查看某表上索引 
</code></pre></li>
</ul>
<h3 id="7-使用SQL提示"><a href="#7-使用SQL提示" class="headerlink" title="7.使用SQL提示"></a>7.使用SQL提示</h3><ul>
<li>SQL中加入一些人为提示达到优化操作的目的</li>
</ul>
<h3 id="8-use-index"><a href="#8-use-index" class="headerlink" title="8.use index"></a>8.use index</h3><ul>
<li><p>查询语句表名后面，添加use index提供希望mysql参考的索引列表</p>
<pre><code>select * from table_name use index (idx_test_id) where ...
</code></pre></li>
</ul>
<h3 id="9-ignore-index"><a href="#9-ignore-index" class="headerlink" title="9,ignore index"></a>9,ignore index</h3><ul>
<li>忽略一个或者多个索引</li>
</ul>
<h3 id="10-force-index"><a href="#10-force-index" class="headerlink" title="10.force index"></a>10.force index</h3><ul>
<li>强制使用一个特定索引</li>
</ul>
<hr>
<h1 id="优化数据库对象"><a href="#优化数据库对象" class="headerlink" title="优化数据库对象"></a>优化数据库对象</h1><h2 id="1-优化表的数据类型"><a href="#1-优化表的数据类型" class="headerlink" title="1.优化表的数据类型"></a>1.优化表的数据类型</h2><ul>
<li><p>PROCEDURE ANALYSE() 对当前表进行分析</p>
<pre><code>select * from table_name PROCEDURE ANALYSE()
</code></pre></li>
</ul>
<h2 id="2-通过拆分提高表的访问效率"><a href="#2-通过拆分提高表的访问效率" class="headerlink" title="2.通过拆分提高表的访问效率"></a>2.通过拆分提高表的访问效率</h2><ul>
<li>垂直拆分：eg.OrderMain和OrderDetail<ul>
<li>优点：数据行变小，数据页存放更多数据，查询时减少I/O次数</li>
<li>缺点：管理冗余列。查询时需要JOIN操作</li>
</ul>
</li>
<li>水平拆分：将一列或多列数据值放到两个独立表中<ul>
<li>表很大，分割后降低在查询时需要读的数据和索引页数。降低索引层数</li>
<li>数据独立性</li>
<li>数据存放在多个介质中</li>
<li>缺点：增加复杂度</li>
</ul>
</li>
</ul>
<h2 id="3-逆规范化"><a href="#3-逆规范化" class="headerlink" title="3.逆规范化"></a>3.逆规范化</h2><p>   适当考虑表的冗余字段，不需要在做关联查询，而让查询有更好的性能。<br>   逆规范的好处是降低连接操作的需求和索引数目。甚至可能减少表数目。但是可能影响数据完整性。</p>
<ul>
<li>增加冗余列</li>
<li>增加派生列</li>
<li>重新组表</li>
<li>分割表</li>
</ul>
<h2 id="4-使用中间表提高统计查询速度"><a href="#4-使用中间表提高统计查询速度" class="headerlink" title="4.使用中间表提高统计查询速度"></a>4.使用中间表提高统计查询速度</h2><hr>
<h1 id="锁问题"><a href="#锁问题" class="headerlink" title="锁问题"></a>锁问题</h1><p>MySQL在不同存储引擎下支持不同的锁机制</p>
<ul>
<li>表级锁：MyISAM和MEMORY</li>
<li>页面锁：BOBO</li>
<li>行级锁：InnoDB(也支持表级锁)</li>
</ul>
<h2 id="3种锁的特性"><a href="#3种锁的特性" class="headerlink" title="3种锁的特性"></a>3种锁的特性</h2><ul>
<li>表级锁：开销小，加锁快。不会出现死锁；锁定粒度大，发生锁冲突频率最高，并发度最低</li>
<li>行级锁：开销大，加锁慢，会出现死锁；锁定粒度小；发生锁冲突概率最低，并发度最高</li>
<li>页面锁：开销介于表锁和行锁之间，会出现死锁。锁定粒度介于表锁行锁之间。并发程度一般</li>
</ul>
<h2 id="MyISAM表锁"><a href="#MyISAM表锁" class="headerlink" title="MyISAM表锁"></a>MyISAM表锁</h2><h3 id="查询表争用情况"><a href="#查询表争用情况" class="headerlink" title="查询表争用情况"></a>查询表争用情况</h3><pre><code>show status like &apos;table%&apos;;
</code></pre><ul>
<li>Table_locks_waited:值越高，则说明存在严重的表级锁争用<ul>
<li>MyISAM读锁不会其他用户对同一个表的请求，但会阻塞同一个表的写请求。一个线程获得表的写锁后。只有持有锁的线程对表进行更新操作。其他的读线程等待。直到被释放。</li>
</ul>
</li>
</ul>
<h4 id="显式加锁"><a href="#显式加锁" class="headerlink" title="显式加锁"></a>显式加锁</h4><pre><code>Lock tables table_name_1 read local, table_name_2 read local
... --sql语句
Unlock tables
</code></pre><h4 id="获取锁"><a href="#获取锁" class="headerlink" title="获取锁"></a>获取锁</h4><pre><code>lock table table_name as alias read;
</code></pre><h4 id="并发插入"><a href="#并发插入" class="headerlink" title="并发插入"></a>并发插入</h4><p>MyISAM的读写串行，在一定条件下，MyISAM表也支持查询和插入操作的并发进行</p>
<pre><code>concurrent_insert --控制其并发插入的行为
</code></pre><ul>
<li>concurrent_insert=0 不允许并发插入</li>
<li>concurrent_insert=1 MyISAM允许在一个进程读表的同时，另一个进程从表尾插入记录（默认设置）</li>
<li>concurrent_insert=2 都允许在表尾并发插入记录</li>
</ul>
<h4 id="MyISAM锁调度"><a href="#MyISAM锁调度" class="headerlink" title="MyISAM锁调度"></a>MyISAM锁调度</h4><blockquote>
<p>写进程获取锁，读请求先到锁等待队列，写请求厚道，写锁会插入到读锁请求之前。（由于一特性，myISAM不适合大量更新和查询操作。大量更新操作会造成查询操作很难获得锁，从而一直阻塞。）</p>
</blockquote>
<ul>
<li>指定启动参数low-priority-updates:默认给予都请求优先</li>
<li>set low_priority_updates = 1 使该连接发出的更新请求优先级降低</li>
<li>指定insert、update、delete的low_priority属性，降低该语句优先级</li>
</ul>
<hr>
<h2 id="InnoDB行锁"><a href="#InnoDB行锁" class="headerlink" title="InnoDB行锁"></a>InnoDB行锁</h2><p><strong>MyISAM与InnoDB最大不同：支持事务、采用行级锁。</strong></p>
<h3 id="事务ACID属性"><a href="#事务ACID属性" class="headerlink" title="事务ACID属性"></a>事务ACID属性</h3><ul>
<li>原子性 （要么全部执行，要么全部失败）</li>
<li>一致性  （事务开始和完成，数据必须保持一致状态，保持数据完整性）</li>
<li>隔离性 （保证事务不受外部并发操作影响）</li>
<li>持久性：事务一旦提交。对于数据修改是永久的）</li>
</ul>
<h3 id="并发事务处理带来的问题"><a href="#并发事务处理带来的问题" class="headerlink" title="并发事务处理带来的问题"></a>并发事务处理带来的问题</h3><ul>
<li>更新丢失：2个或多个事务更新同一行，但是每个事务都不知道彼此的存在，会发生丢失更新问题</li>
<li>脏读：一个事务正在对一条记录进行修改，但是并未提交。数据处于不一致状态；另一个事务读取同一条记录，如果不加控制。就会读取到脏数据，产生未提交数据依赖关系</li>
<li>不可重复读：一个事务在读取数据后某个时间按，再次读取以前读果的数据，发生了改变（或者已经删除）</li>
<li>幻读：一个事务按相同的查询条件重新读取以前检索过的额数据，发现其他事务插入了满足其查询条件的新数据</li>
</ul>
<h3 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h3><ul>
<li>读取数据前，对其加锁，阻止其他事务对其数据进行修改</li>
<li>不加任何锁，通过一定机制生成一个数据请求时间点一致性数据快照，并用这个快照提供一定级别的一致性读取（这种叫做数据库多版本并发控制，称为MVCC）</li>
</ul>
<p><strong>事务隔离越严格，并发副作用越小，旦代价越大；事务隔离实质就是使事务在一定程度上”串行化”进行</strong></p>
<ul>
<li>未提交读</li>
<li>已提交读</li>
<li>可重复读</li>
<li>可序列化</li>
</ul>
<h3 id="获取InnoDB锁争用情况"><a href="#获取InnoDB锁争用情况" class="headerlink" title="获取InnoDB锁争用情况"></a>获取InnoDB锁争用情况</h3><pre><code>show status like &apos;innodb_row_lock%&apos;
+-------------------------------+-------+
| Variable_name                 | Value |
+-------------------------------+-------+
| Innodb_row_lock_current_waits | 0     |
| Innodb_row_lock_time          | 0     |
| Innodb_row_lock_time_avg      | 0     |
| Innodb_row_lock_time_max      | 0     |
| Innodb_row_lock_waits         | 0     |
+-------------------------------+-------+
</code></pre><p>如果锁争用的情况比较严重。还可以设置Innodb Monitors进一步观察锁冲突、数据行。具体分析原因</p>
<h3 id="InnoDB行锁模式以及加锁方法"><a href="#InnoDB行锁模式以及加锁方法" class="headerlink" title="InnoDB行锁模式以及加锁方法"></a>InnoDB行锁模式以及加锁方法</h3><ul>
<li>共享锁S：允许一个事务读取一行，阻止其他事务获得相同数据集的排它锁</li>
<li>排它锁X：允许获得排它锁的事务更新数据，阻止其他事务取得相同数据集的共享读锁和排他写锁</li>
<li>意向共享锁IS：事务打算给数据行加行共享锁，事务在给一个数据行加共享锁前必须取得该表的IS锁</li>
<li><p>意向排它锁IX：事务打算给数据行加排它锁，事务在给定一个数据行加排它锁前必须取得该表的IX锁</p>
<p> – 共享锁<br> select <em> from table_name where … LOCK IN SHARE MODE<br> – 排它锁<br> select </em> from table_name where … FOR UPDATE</p>
</li>
</ul>
<ul>
<li>LOCK IN SHARE MODE：从数据依存关系确认某行记录是否存在，并确保没有人对这个记录进行update或者insert操作。但如果当前事务需要对该记录进行更新操作，可能会造成死锁‘</li>
<li>FOR UPDATE ： 对于锁定行需要进行更新的记录，使用排他锁</li>
</ul>
<h3 id="InnoDB行锁实现方式"><a href="#InnoDB行锁实现方式" class="headerlink" title="InnoDB行锁实现方式"></a>InnoDB行锁实现方式</h3><ul>
<li>InnoDB通过给索引上的索引项加锁实现。只有通过索引条件检索数据，InnoDB才使用行级锁，否则，使用表锁。</li>
<li>当表游多个索引，不同事务使用不同索引锁定不同的行</li>
<li>分析锁冲突，需要检查sql执行计划（explain）</li>
</ul>
<h4 id="间隙锁（Next-Key）"><a href="#间隙锁（Next-Key）" class="headerlink" title="间隙锁（Next-Key）"></a>间隙锁（Next-Key）</h4><blockquote>
<p>通过范围条件而不是相等条件检索数据，并请求共享排它锁时，InnoDB会给符合条件的已有数据记录的索引项加锁：对于键值在条件范围内但并不存在的记录，叫做间隙。InnoDB对这个间隙加锁</p>
</blockquote>
<pre><code>select * from table_name from col_1 &gt; 100 for update
</code></pre><p>使用间隙的目的<br>1.防止幻读，满足相关隔离级别<br>2.满足恢复和复制</p>
<pre><code>select @@tx_isolation;
</code></pre><p><strong>复制本质：在SlaveMysql不断做基于binlog的复制</strong><br><strong>恢复机制：在一个事务未提交前，其他并发事务不能插入满足其锁定条件的任何记录（不允许幻读）。无论在ReadCommited或者RepeatableRead隔离级别下，InnoDB都要使用间隙锁</strong></p>
<hr>
<h2 id="优化MySQL"><a href="#优化MySQL" class="headerlink" title="优化MySQL"></a>优化MySQL</h2><pre><code>show variables --服务器静态参数值
show status  --动态运行状态
show warnings
</code></pre><h3 id="相关参数"><a href="#相关参数" class="headerlink" title="相关参数"></a>相关参数</h3><ul>
<li>key_buffer_size</li>
<li>table_cache</li>
<li>innodb_buffer_pool_size</li>
<li>innodb_flush_at_trx_commit</li>
<li>innodb_additional_mem_pool_size</li>
<li>innodb_lock_wait_timeout</li>
<li>innodb_support_xa</li>
<li>innodb_log_buffer_size</li>
<li>innodb_log_file_size</li>
</ul>
<h3 id="磁盘阵列-RAID"><a href="#磁盘阵列-RAID" class="headerlink" title="磁盘阵列(RAID)"></a>磁盘阵列(RAID)</h3><h4 id="RAID级别"><a href="#RAID级别" class="headerlink" title="RAID级别"></a>RAID级别</h4><ul>
<li><p>RAID 0： </p>
<ul>
<li>特性：条带化。按一定的条带大小将数据依次分布到各个盘中，无数据冗余。</li>
<li>优点：并发读写快。无额外磁盘空间开销</li>
<li>缺点：数据无冗余保护，可靠性差</li>
</ul>
</li>
<li><p>RAID 1:</p>
<ul>
<li>特性：磁盘镜像，两个磁盘一组，所有数据同时写入两个磁盘。读取任一磁盘即可</li>
<li>优点：有冗余保护。只要不出现两块磁盘同时损坏。提高并发读写性能</li>
<li>缺点：容量一定的情况，磁盘空间占用大</li>
</ul>
</li>
<li><p>RAID 10</p>
<ul>
<li>特性：RAID 0 和 RAID 10 结合。先对磁盘做镜像，在条带化</li>
<li>优点：可靠性高。并发读写性能优良</li>
<li>缺点：容量一定的情况，磁盘空间占用大</li>
</ul>
</li>
<li><p>RAID 4</p>
<ul>
<li>特性：如RAID 0一样对磁盘组条带化，不同的时：需要额外增加一个磁盘。写各Stripe（条带）的校验纠错数据</li>
<li>优点：RAID中一个磁盘损坏可以通过校验纠错数据计算，保障容错信息；读取数据快</li>
<li>缺点：每个Stripe写校验纠错块，性能有影响。所有纠错数据在同一磁盘，风险大，容易形成性能瓶颈。出现坏盘，性能下降</li>
</ul>
</li>
<li><p>RAID 5</p>
<ul>
<li>特性：对RAID 4的改进，将每个条带的校验纠错数据分布写到各个磁盘，而不是写入特定磁盘</li>
<li>优点：性能和数据保护能力强于RAID 4</li>
<li>缺点：写性能不及RAID 0、RAID 1和RAID 10；容错能力不及RAID 1</li>
</ul>
</li>
</ul>
<h3 id="如何选择RAID级别"><a href="#如何选择RAID级别" class="headerlink" title="如何选择RAID级别"></a>如何选择RAID级别</h3><ul>
<li>数据读写很频繁，可靠性较高，最好选择RAID 10</li>
<li>数据读频繁，写较少，对可靠性有一定要求，可选RAID 5</li>
<li>数据读写都很频繁，可靠性要求不高，可选RAID 0</li>
</ul>
<h4 id="使用Symbolic-Links分布I-O"><a href="#使用Symbolic-Links分布I-O" class="headerlink" title="使用Symbolic Links分布I/O"></a>使用Symbolic Links分布I/O</h4><h4 id="禁止操作系统更新文件的atime属性"><a href="#禁止操作系统更新文件的atime属性" class="headerlink" title="禁止操作系统更新文件的atime属性"></a>禁止操作系统更新文件的atime属性</h4><hr>
<h2 id="应用优化"><a href="#应用优化" class="headerlink" title="应用优化"></a>应用优化</h2><h3 id="1-使用连接池"><a href="#1-使用连接池" class="headerlink" title="1.使用连接池"></a>1.使用连接池</h3><h3 id="2-减少对MySQL的访问"><a href="#2-减少对MySQL的访问" class="headerlink" title="2.减少对MySQL的访问"></a>2.减少对MySQL的访问</h3><p>2.1. 避免对同一数据进行重复检索<br>2.2. 使用查询缓存</p>
<pre><code>show variables like &apos;%query_cache%&apos;
</code></pre><p>2.3. 增加Cache层</p>
<h3 id="3-负载均衡"><a href="#3-负载均衡" class="headerlink" title="3.负载均衡"></a>3.负载均衡</h3><p>2.2. 利用MySQL复制分流查询操作</p>
<pre><code>- MySQL主从复制有效的分流更新操作和查询操作
  - 具体实现：主服务器承担更新操作，多台服务器承担查询操作；主从之间通过复制进行数据同步；多台从服务器确保可用性；另一方面可以通过不同索引满足不同需要
  - 缺点：当主数据库更新频繁或者网络出现问题时，主从之间的数据存在比较大的延迟更新造成查询结果和主数据库上有所差异
</code></pre><p>2.3. 采用分布式数据库结构</p>
<pre><code>- 注：如果使用分布式架构数据库，必须采用InnoDBZ
</code></pre><h3 id="4-其他优化"><a href="#4-其他优化" class="headerlink" title="4.其他优化"></a>4.其他优化</h3><pre><code>- 对于没有删除行操作的MyISAM表，插入和查询可以并行进行，没有删除操作的表查询期间不会阻塞插入操作。对于需要执行删除操作的表，尽量在空闲时间执行批量删除，并在删除操作后进行optimize。避免将来更新阻塞其他操作
- 充分利用默认值
- 表尽量不适用自增长字段
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/06/02/OAuth2-0简单记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="dzx">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://wx2.sinaimg.cn/mw690/63b4ac8dgy1ffzs5lll1oj20zk0qoq4z.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dzxblog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/02/OAuth2-0简单记录/" itemprop="url">OAuth2.0简单记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-02T14:35:26+08:00">
                2017-06-02
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OAuth/" itemprop="url" rel="index">
                    <span itemprop="name">OAuth</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="OAuth2-0记录概要"><a href="#OAuth2-0记录概要" class="headerlink" title="OAuth2.0记录概要"></a>OAuth2.0记录概要</h1><h2 id="认证授权-Authorization"><a href="#认证授权-Authorization" class="headerlink" title="认证授权(Authorization)"></a>认证授权(Authorization)</h2><ul>
<li>资源授权码</li>
<li>密码凭据</li>
<li>客户端证书</li>
<li>Implicit</li>
</ul>
<h2 id="访问令牌-Token"><a href="#访问令牌-Token" class="headerlink" title="访问令牌(Token)"></a>访问令牌(Token)</h2><h2 id="版本安全-TLS-Version"><a href="#版本安全-TLS-Version" class="headerlink" title="版本安全(TLS Version)"></a>版本安全(TLS Version)</h2><h2 id="HTTP重定向"><a href="#HTTP重定向" class="headerlink" title="HTTP重定向"></a>HTTP重定向</h2><h2 id="客户端注册"><a href="#客户端注册" class="headerlink" title="客户端注册"></a>客户端注册</h2><ul>
<li><p>客户端类型</p>
</li>
<li><p>客户端标识符</p>
</li>
<li><p>客户端认证</p>
<ol>
<li>客户端密码</li>
<li>其他认证方式</li>
</ol>
</li>
</ul>
<h2 id="协议端点"><a href="#协议端点" class="headerlink" title="协议端点"></a>协议端点</h2><ul>
<li><p>认证端点</p>
<ul>
<li>响应类型</li>
<li>重定向端点</li>
</ul>
</li>
<li><p>令牌端点</p>
<ul>
<li>客户端认证</li>
</ul>
</li>
<li><p>安全令牌作用域 </p>
</li>
</ul>
<h2 id="获取认证"><a href="#获取认证" class="headerlink" title="获取认证"></a>获取认证</h2><ul>
<li><p>授权码授权</p>
<ul>
<li>授权请求</li>
<li>授权响应</li>
<li>访问令牌请求</li>
<li>访问令牌响应</li>
</ul>
</li>
<li><p>Implicit授权</p>
<ul>
<li>授权请求</li>
<li>访问令牌请求</li>
</ul>
</li>
<li><p>密码凭据</p>
<ul>
<li>授权请求以及响应</li>
<li>访问令牌请求</li>
<li>访问令牌响应</li>
</ul>
</li>
<li><p>证书授权 </p>
<ul>
<li>授权请求以及响应</li>
<li>访问令牌请求</li>
<li>访问令牌响应</li>
</ul>
</li>
</ul>
<h2 id="发行访问令牌"><a href="#发行访问令牌" class="headerlink" title="发行访问令牌"></a>发行访问令牌</h2><ul>
<li>访问令牌类型</li>
<li>错误响应</li>
</ul>
<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><ul>
<li>定义AccessToken类型</li>
<li>定义新的端口参数</li>
<li>定义新的授权类型</li>
<li>定义新的授权端点响应类型</li>
<li>定义错误码</li>
</ul>
<hr>
<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><ul>
<li>client_id</li>
<li>client_secret</li>
<li>reponse_type</li>
<li>scope</li>
<li>state</li>
<li>redirect_uri</li>
<li>error</li>
<li>error_description</li>
<li>error_uri</li>
<li>grant_type</li>
<li>code</li>
<li>access_token</li>
<li>token_type</li>
<li>expires_in</li>
<li>username</li>
<li>password</li>
<li>refresh_token</li>
</ul>
<hr>
<h2 id="OAuth2-0角色"><a href="#OAuth2-0角色" class="headerlink" title="OAuth2.0角色"></a>OAuth2.0角色</h2><ul>
<li>资源所有者</li>
<li>资源服务器</li>
<li>客户端</li>
<li>授权服务器</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/12/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><span class="page-number current">13</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://wx2.sinaimg.cn/mw690/63b4ac8dgy1ffzs5lll1oj20zk0qoq4z.jpg"
               alt="dzx" />
          <p class="site-author-name" itemprop="name">dzx</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">124</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">46</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">98</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dzx</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

  

</body>
</html>
